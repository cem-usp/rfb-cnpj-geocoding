<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta charset="UTF-8">
<meta name="generator" content="quarto-1.8.24">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<meta name="author" content="Daniel Vartanian, Clara L. S. Penz, Camila N. Fernandes, &amp; Mariana A. Giannotti">
<meta name="dcterms.date" content="2025-11-01">
<title>A Reproducible Pipeline for Processing and Geocoding CNPJs from the Brazilian Federal Revenue Service (RFB)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<link href="./images/favicon.svg" rel="icon" type="image/svg+xml">
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-51ed2b7efba85c808986edec323c5e71.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-6efe224236f7e5a1615e5d2b42852a6b.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-51ed2b7efba85c808986edec323c5e71.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-bb5183dd889ed94b30793f9b52eee8b6.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-d3ef5e81a44729a7b94f400bdb21a674.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-bb5183dd889ed94b30793f9b52eee8b6.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet"><script id="quarto-search-options" type="application/json">{
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<meta property="og:title" content="A Reproducible Pipeline for Processing and Geocoding CNPJs from the Brazilian Federal Revenue Service (RFB)">
<meta property="og:description" content="">
<meta property="og:image" content="https://cem-usp.github.io/rfb-cnpj-geocoding/images/og-image.png">
<meta property="og:image:alt" content="Center for Metropolitan Studies">
<meta property="og:image:height" content="1600">
<meta property="og:image:width" content="2400">
<meta name="citation_title" content="A Reproducible Pipeline for Processing and Geocoding CNPJs from the Brazilian Federal Revenue Service (RFB)
">
<meta name="citation_author" content="Daniel Vartanian, Clara L. S. Penz, Camila N. Fernandes, &amp;amp; Mariana A. Giannotti">
<meta name="citation_publication_date" content="2025-11-01">
<meta name="citation_cover_date" content="2025-11-01">
<meta name="citation_year" content="2025">
<meta name="citation_online_date" content="2025-11-01">
<meta name="citation_fulltext_html_url" content="https://cem-usp.github.io/rfb-cnpj-geocoding/">
<meta name="citation_language" content="en">
<meta name="citation_reference" content="citation_title=Quarto;,citation_abstract=Quarto is an open-source scientific and technical publishing system built on Pandoc.;,citation_author=J. J. Allaire;,citation_author=Charles Teague;,citation_author=Yihui Xie;,citation_author=Christophe Dervieux;,citation_fulltext_html_url=https://quarto.org;,citation_doi=10.5281/ZENODO.5960048;,citation_publisher=Zenodo;">
<meta name="citation_reference" content="citation_title=terra: Spatial Data Analysis;,citation_abstract=terra provides methods to manipulate geographic (spatial) data in &amp;amp;amp;quot;raster&amp;quot; and &quot;vector&quot; form. Raster data divide space into rectangular grid cells and they are commonly used to represent spatially continuous phenomena, such as elevation or the weather. Satellite images also have this data structure, and in that context grid cells are often referred to as pixels. In contrast, &quot;vector&quot; spatial data (points, lines, polygons) are typically used to represent discrete spatial entities, such as a road, country, or bus stop.;,citation_author=Robert J. Hijmans;,citation_fulltext_html_url=https://rspatial.org;">
<meta name="citation_reference" content="citation_title=R: A language and environment for statistical computing;,citation_author=R Core Team;,citation_fulltext_html_url=https://www.R-project.org;,citation_publisher=R Foundation for Statistical Computing;">
<meta name="citation_reference" content="citation_title=renv: Project environments;,citation_abstract=A dependency management toolkit for R. Using ’renv’, you can create and manage project-local R libraries, save the state of these libraries to a ’lockfile’, and later restore your library as required. Together, these tools can help make your projects more isolated, portable, and reproducible.;,citation_author=Kevin Ushey;,citation_author=Hadley Wickham;,citation_fulltext_html_url=https://doi.org/10.32614/CRAN.package.renv;">
<meta name="citation_reference" content="citation_title=The tidy tools manifesto;,citation_abstract=tidyverse;,citation_author=Hadley Wickham;,citation_publication_date=2023;,citation_cover_date=2023;,citation_year=2023;,citation_fulltext_html_url=https://tidyverse.tidyverse.org/articles/manifesto.html;,citation_language=en-US;,citation_publisher=Tidyverse;">
<meta name="citation_reference" content="citation_title=R for data science: Import, tidy, transform, visualize, and model data;,citation_abstract=Use R to turn data into insight, knowledge, and understanding. With this practical book, aspiring data scientists will learn how to do data science with R and RStudio, along with the tidyverseâ??a collection of R packages designed to work together to make data science fast, fluent, and fun. Even if you have no programming experience, this updated edition will have you doing data science quickly. You’ll learn how to import, transform, and visualize your data and communicate the results. And you’ll get a complete, big-picture understanding of the data science cycle and the basic tools you need to manage the details. Updated for the latest tidyverse features and best practices, new chapters show you how to get data from spreadsheets, databases, and websites. Exercises help you practice what you’ve learned along the way.;,citation_author=Hadley Wickham;,citation_author=Mine Çetinkaya-Rundel;,citation_author=Garrett Grolemund;,citation_publication_date=2023;,citation_cover_date=2023;,citation_year=2023;,citation_fulltext_html_url=https://r4ds.hadley.nz;,citation_isbn=978-1-4920-9740-2;,citation_language=en-US;">
</head>
<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item compact">
    <a class="nav-link" href="https://github.com/cem-usp/rfb-cnpj-geocoding/"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#problem" id="toc-problem" class="nav-link" data-scroll-target="#problem">Problem</a></li>
  <li><a href="#data-availability" id="toc-data-availability" class="nav-link" data-scroll-target="#data-availability">Data Availability</a></li>
  <li>
<a href="#methods" id="toc-methods" class="nav-link" data-scroll-target="#methods">Methods</a>
  <ul>
<li><a href="#source-of-data" id="toc-source-of-data" class="nav-link" data-scroll-target="#source-of-data">Source of Data</a></li>
  <li><a href="#data-munging" id="toc-data-munging" class="nav-link" data-scroll-target="#data-munging">Data Munging</a></li>
  <li><a href="#code-style" id="toc-code-style" class="nav-link" data-scroll-target="#code-style">Code Style</a></li>
  <li><a href="#reproducibility" id="toc-reproducibility" class="nav-link" data-scroll-target="#reproducibility">Reproducibility</a></li>
  </ul>
</li>
  <li>
<a href="#set-the-environment" id="toc-set-the-environment" class="nav-link" data-scroll-target="#set-the-environment">Set the Environment</a>
  <ul>
<li><a href="#load-packages" id="toc-load-packages" class="nav-link" data-scroll-target="#load-packages">Load Packages</a></li>
  <li><a href="#set-keys" id="toc-set-keys" class="nav-link" data-scroll-target="#set-keys">Set Keys</a></li>
  <li><a href="#set-google-sheets-api" id="toc-set-google-sheets-api" class="nav-link" data-scroll-target="#set-google-sheets-api">Set Google Sheets API</a></li>
  <li><a href="#set-input-and-output-paths" id="toc-set-input-and-output-paths" class="nav-link" data-scroll-target="#set-input-and-output-paths">Set Input and Output Paths</a></li>
  <li><a href="#set-initial-variables" id="toc-set-initial-variables" class="nav-link" data-scroll-target="#set-initial-variables">Set Initial Variables</a></li>
  </ul>
</li>
  <li><a href="#download-cnae-classification-table" id="toc-download-cnae-classification-table" class="nav-link" data-scroll-target="#download-cnae-classification-table">Download CNAE Classification Table</a></li>
  <li><a href="#download-data-on-brazilian-agencies-and-municipalities" id="toc-download-data-on-brazilian-agencies-and-municipalities" class="nav-link" data-scroll-target="#download-data-on-brazilian-agencies-and-municipalities">Download Data on Brazilian Agencies and Municipalities</a></li>
  <li>
<a href="#download-the-rfb-raw-data" id="toc-download-the-rfb-raw-data" class="nav-link" data-scroll-target="#download-the-rfb-raw-data">Download the RFB Raw Data</a>
  <ul>
<li><a href="#set-parameters" id="toc-set-parameters" class="nav-link" data-scroll-target="#set-parameters">Set Parameters</a></li>
  <li><a href="#download-files" id="toc-download-files" class="nav-link" data-scroll-target="#download-files">Download Files</a></li>
  <li><a href="#unzip-files" id="toc-unzip-files" class="nav-link" data-scroll-target="#unzip-files">Unzip Files</a></li>
  </ul>
</li>
  <li><a href="#read-tom-municipality-codes" id="toc-read-tom-municipality-codes" class="nav-link" data-scroll-target="#read-tom-municipality-codes">Read TOM Municipality Codes</a></li>
  <li><a href="#replace-ibge-municipality-codes-with-tom-codes" id="toc-replace-ibge-municipality-codes-with-tom-codes" class="nav-link" data-scroll-target="#replace-ibge-municipality-codes-with-tom-codes">Replace IBGE Municipality Codes with TOM Codes</a></li>
  <li><a href="#read-the-data" id="toc-read-the-data" class="nav-link" data-scroll-target="#read-the-data">Read the Data</a></li>
  <li><a href="#filter-the-data" id="toc-filter-the-data" class="nav-link" data-scroll-target="#filter-the-data">Filter the Data</a></li>
  <li><a href="#tidy-the-data" id="toc-tidy-the-data" class="nav-link" data-scroll-target="#tidy-the-data">Tidy the Data</a></li>
  <li><a href="#arrange-the-data" id="toc-arrange-the-data" class="nav-link" data-scroll-target="#arrange-the-data">Arrange the Data</a></li>
  <li><a href="#geocode-the-data" id="toc-geocode-the-data" class="nav-link" data-scroll-target="#geocode-the-data">Geocode the Data</a></li>
  <li><a href="#data-dictionary" id="toc-data-dictionary" class="nav-link" data-scroll-target="#data-dictionary">Data Dictionary</a></li>
  <li><a href="#save-the-valid-data" id="toc-save-the-valid-data" class="nav-link" data-scroll-target="#save-the-valid-data">Save the Valid Data</a></li>
  <li>
<a href="#visualize-the-data" id="toc-visualize-the-data" class="nav-link" data-scroll-target="#visualize-the-data">Visualize the Data</a>
  <ul>
<li><a href="#set-variables" id="toc-set-variables" class="nav-link" data-scroll-target="#set-variables">Set Variables</a></li>
  <li><a href="#set-shape" id="toc-set-shape" class="nav-link" data-scroll-target="#set-shape">Set Shape</a></li>
  <li><a href="#prepare-data" id="toc-prepare-data" class="nav-link" data-scroll-target="#prepare-data">Prepare Data</a></li>
  <li><a href="#plot-data" id="toc-plot-data" class="nav-link" data-scroll-target="#plot-data">Plot Data</a></li>
  </ul>
</li>
  <li><a href="#citation" id="toc-citation" class="nav-link" data-scroll-target="#citation">Citation</a></li>
  <li><a href="#license" id="toc-license" class="nav-link" data-scroll-target="#license">License</a></li>
  <li><a href="#acknowledgments" id="toc-acknowledgments" class="nav-link" data-scroll-target="#acknowledgments">Acknowledgments</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/cem-usp/rfb-cnpj-geocoding/edit/main/index.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/cem-usp/rfb-cnpj-geocoding/blob/main/index.qmd" class="toc-action"><i class="bi empty"></i>View source</a></li><li><a href="https://github.com/cem-usp/rfb-cnpj-geocoding/issues/" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div><div class="quarto-other-links"><h2>Other Links</h2><ul><li><a href="https://centrodametropole.fflch.usp.br"><i class="bi bi-link-45deg"></i>Center for Metropolitan Studies</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title"></h1>
<p>A Reproducible Pipeline for Processing and Geocoding CNPJs from the Brazilian Federal Revenue Service (RFB)</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Daniel Vartanian, Clara L. S. Penz, Camila N. Fernandes, &amp; Mariana A. Giannotti </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 1, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header><!-- badges: start --><p><a href="https://www.repostatus.org/#wip"><img src="https://www.repostatus.org/badges/latest/wip.svg" class="img-fluid" alt="Project Status: WIP – Initial development is in progress, but there has not yet been a stable, usable release suitable for the public."></a> <a href="https://doi.org/10.17605/OSF.IO/2X6JB"><img src="https://img.shields.io/badge/OSF-10.17605/OSF.IO/2X6JB-1284C5.svg" class="img-fluid"></a> <a href="https://www.gnu.org/licenses/gpl-3.0"><img src="https://img.shields.io/badge/license-GPLv3-bd0000.svg" class="img-fluid" alt="License: GPLv3"></a> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><img src="https://img.shields.io/badge/license-CC_BY--NC--SA_4.0-lightgrey.svg" class="img-fluid" alt="License: CC BY-NC-SA 4.0"></a> <!-- badges: end --></p>
<div class="callout callout-style-simple callout-important">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>This pipeline is a <strong>Work In Progress</strong> (WIP) and is under active development. It may not yet be stable or suitable for public use. Please use it with caution and report any issues you encounter.</p>
</div>
</div>
</div>
<section id="overview" class="level2"><h2 class="anchored" data-anchor-id="overview">Overview</h2>
<p>This report provides a fully reproducible pipeline for processing and <a href="https://en.wikipedia.org/wiki/Address_geocoding">geocoding</a> <a href="https://en.wikipedia.org/wiki/CNPJ">CNPJ</a>s from the Brazilian Federal Revenue Service (<a href="https://www.gov.br/receitafederal/">RFB</a>).</p>
</section><section id="problem" class="level2"><h2 class="anchored" data-anchor-id="problem">Problem</h2>
<p>The <a href="https://doi.org/10.17605/OSF.IO/ZE6WT">AcessoSAN</a> project aims to develop methods for measuring and analyzing inequities in access to healthy food in favelas and other urban communities. Achieving this requires a reliable and up-to-date database of food retail establishments.</p>
<p>The Brazilian Federal Revenue Service (<a href="https://www.gov.br/receitafederal/">RFB</a>) <a href="https://en.wikipedia.org/wiki/CNPJ">CNPJ</a>s database lists companies operating in Brazil, including food retail establishments. However, it does not provide <a href="https://en.wikipedia.org/wiki/Address_geocoding">geocoded information</a>, which is required for spatial analyses. This pipeline addresses that gap by processing and <a href="https://en.wikipedia.org/wiki/Address_geocoding">geocoding</a> the data.</p>
</section><section id="data-availability" class="level2"><h2 class="anchored" data-anchor-id="data-availability">Data Availability</h2>
<div style="text-align: left;">
<p><a href="https://doi.org/10.17605/OSF.IO/2X6JB"><img src="https://img.shields.io/badge/OSF-10.17605/OSF.IO/2X6JB-1284C5.svg" class="img-fluid"></a></p>
</div>
<p>The processed data are available in both <a href="https://rdrr.io/r/base/readRDS.html"><code>rds</code></a> and <a href="https://en.wikipedia.org/wiki/Comma-separated_values"><code>csv</code></a> formats through a dedicated repository on the Open Science Framework (<a href="https://osf.io/">OSF</a>), accessible <a href="https://doi.org/10.17605/OSF.IO/2X6JB">here</a>. A metadata file is included alongside the validated datasets. You can also retrieve these files directly from <a href="https://www.r-project.org/">R</a> using the <a href="https://docs.ropensci.org/osfr/"><code>osfr</code></a> package.</p>
</section><section id="methods" class="level2"><h2 class="anchored" data-anchor-id="methods">Methods</h2>
<section id="source-of-data" class="level3"><h3 class="anchored" data-anchor-id="source-of-data">Source of Data</h3>
<p>The data used in this report come from the following sources:</p>
<ul>
<li>Brazilian Federal Revenue Service (<a href="https://www.gov.br/receitafederal/">RFB</a>):
<ul>
<li>Data on food retail establishments from the <a href="https://dados.gov.br/dados/conjuntos-dados/cadastro-nacional-da-pessoa-juridica---cnpj">CNPJ database</a>, used for company identification.</li>
<li>Data on <a href="https://dados.gov.br/dados/conjuntos-dados/tabela-de-rgos-e-municpios">Brazilian agencies and municipalities</a> (<em>Tabela de Órgãos e Municípios</em>).</li>
</ul>
</li>
<li>Brazilian Institute of Geography and Statistics (<a href="https://www.ibge.gov.br/">IBGE</a>): Open spatial datasets of Brazilian addresses from the National Address Register for Statistical Purposes (<a href="https://www.ibge.gov.br/estatisticas/sociais/populacao/38734-cadastro-nacional-de-enderecos-para-fins-estatisticos.html">CNEFE</a>), used for geocoding via the <a href="https://ipeagit.github.io/geocodebr/"><code>geocodebr</code></a> R package.</li>
</ul></section><section id="data-munging" class="level3"><h3 class="anchored" data-anchor-id="data-munging">Data Munging</h3>
<p>The data munging follow the data science workflow outlined by <span class="citation" data-cites="wickham2023e">Wickham et al. (<a href="#ref-wickham2023e" role="doc-biblioref">2023</a>)</span>, as illustrated in <a href="#fig-wickham-at-al-2023-figure-1" class="quarto-xref">Figure&nbsp;1</a>. All processes were made using the <a href="https://quarto.org/">Quarto</a> publishing system <span class="citation" data-cites="allaire">(<a href="#ref-allaire" role="doc-biblioref">Allaire et al., n.d.</a>)</span>, the <a href="https://www.r-project.org/">R programming language</a> <span class="citation" data-cites="rcoreteama">(<a href="#ref-rcoreteama" role="doc-biblioref">R Core Team, n.d.</a>)</span> and several R packages.</p>
<p>Spatial data processing was performed using the <a href="https://rspatial.github.io/terra/reference/terra-package.html"><code>terra</code></a> R package <span class="citation" data-cites="hijmans">(<a href="#ref-hijmans" role="doc-biblioref">Hijmans, n.d.</a>)</span> and the <a href="https://rspatial.org/">rspatial</a> framework. For data manipulation and workflow, priority was given to packages from the <a href="https://www.tidyverse.org/">tidyverse</a> and <a href="https://ropensci.org/">rOpenSci</a> ecosystems, as well as other packages adhering to the tidy tools manifesto <span class="citation" data-cites="wickham2023c">(<a href="#ref-wickham2023c" role="doc-biblioref">Wickham, 2023</a>)</span>.</p>
<div id="fig-wickham-at-al-2023-figure-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-wickham-at-al-2023-figure-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Data science workflow created by Wickham, Çetinkaya-Runde, and Grolemund.
</figcaption><div aria-describedby="fig-wickham-at-al-2023-figure-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<p><a href="images/wickham-at-al-2023-figure-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Figure&nbsp;1: Data science workflow created by Wickham, Çetinkaya-Runde, and Grolemund."><img src="images/wickham-at-al-2023-figure-1.png" class="img-fluid figure-img" style="width:75.0%"></a></p>
<p><span class="legend">Source: Reproduced from <span class="citation" data-cites="wickham2023e">Wickham et al. (<a href="#ref-wickham2023e" role="doc-biblioref">2023</a>)</span>.</span></p>
</div>
</figure>
</div>
</section><section id="code-style" class="level3"><h3 class="anchored" data-anchor-id="code-style">Code Style</h3>
<p>The Tidyverse <a href="https://style.tidyverse.org/">code style guide</a> and <a href="https://design.tidyverse.org/">design principles</a> were followed to ensure consistency and enhance readability.</p>
</section><section id="reproducibility" class="level3"><h3 class="anchored" data-anchor-id="reproducibility">Reproducibility</h3>
<p>The pipeline is fully reproducible and can be run again at any time. To ensure consistent results, the <a href="https://rstudio.github.io/renv/"><code>renv</code></a> package <span class="citation" data-cites="usheya">(<a href="#ref-usheya" role="doc-biblioref">Ushey &amp; Wickham, n.d.</a>)</span> is used to manage and restore the R environment. See the <a href="https://github.com/cem-usp/rfb-cnpj-geocoding/blob/main/README.md">README</a> file in the code repository to learn how to run it.</p>
</section></section><section id="set-the-environment" class="level2"><h2 class="anchored" data-anchor-id="set-the-environment">Set the Environment</h2>
<section id="load-packages" class="level3"><h3 class="anchored" data-anchor-id="load-packages">Load Packages</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-lib.r-universe.dev/askpass">askpass</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://danielvartan.github.io/brandr/">brandr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rasmusab/beepr">beepr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://jeroen.r-universe.dev/curl">curl</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://fs.r-lib.org">fs</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ipeagit.github.io/geobr/">geobr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ipeaGIT/geocodebr">geocodebr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://paleolimbot.github.io/ggspatial/">ggspatial</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://googlesheets4.tidyverse.org">googlesheets4</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://here.r-lib.org/">here</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/htmltools">htmltools</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://danielvartan.github.io/lockr/">lockr</a></span><span class="op">)</span> <span class="co"># github.com/danielvartan/lockr</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-lib/nanoparquet">nanoparquet</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://danielvartan.github.io/orbis/">orbis</a></span><span class="op">)</span> <span class="co"># github.com/danielvartan/orbis</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/osfr/">osfr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://readr.tidyverse.org">readr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rvest.tidyverse.org/">rvest</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://danielvartan.github.io/rutils/">rutils</a></span><span class="op">)</span> <span class="co"># github.com/danielvartan/rutils</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://stringi.gagolewski.com/">stringi</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org">stringr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://vroom.r-lib.org">vroom</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-lib/zip">zip</a></span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section><section id="set-keys" class="level3"><h3 class="anchored" data-anchor-id="set-keys">Set Keys</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">osf_pat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"OSF_PAT"</span><span class="op">)</span> <span class="co"># askpass()</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://docs.ropensci.org/osfr/reference/osf_auth.html">osf_auth</a></span><span class="op">(</span><span class="va">osf_pat</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">public_key</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://here.r-lib.org/reference/here.html">here</a></span><span class="op">(</span><span class="st">"_ssh"</span>, <span class="st">"id_rsa.pub"</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">private_key</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://here.r-lib.org/reference/here.html">here</a></span><span class="op">(</span><span class="st">"_ssh"</span>, <span class="st">"id_rsa"</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">password</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"ACESSOSAN_PASSWORD"</span><span class="op">)</span> <span class="co"># askpass()</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section><section id="set-google-sheets-api" class="level3"><h3 class="anchored" data-anchor-id="set-google-sheets-api">Set Google Sheets API</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://googlesheets4.tidyverse.org/reference/gs4_auth.html">gs4_auth</a></span><span class="op">(</span>cache <span class="op">=</span> <span class="st">".secrets"</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section><section id="set-input-and-output-paths" class="level3"><h3 class="anchored" data-anchor-id="set-input-and-output-paths">Set Input and Output Paths</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">raw_data_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://here.r-lib.org/reference/here.html">here</a></span><span class="op">(</span><span class="st">"data-raw"</span><span class="op">)</span></span>
<span><span class="va">data_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://here.r-lib.org/reference/here.html">here</a></span><span class="op">(</span><span class="st">"data"</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">raw_data_dir</span>, <span class="va">data_dir</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://fs.r-lib.org/reference/file_access.html">dir_exists</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://fs.r-lib.org/reference/create.html">dir_create</a></span><span class="op">(</span><span class="va">i</span>, recurse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section><section id="set-initial-variables" class="level3"><h3 class="anchored" data-anchor-id="set-initial-variables">Set Initial Variables</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2025</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">year</span> <span class="op">&lt;-</span> <span class="fl">2025</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">month</span> <span class="op">&lt;-</span> <span class="fl">1</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">municipalities</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span> <span class="co"># IBGE Codes</span></span>
<span>  <span class="fl">3550308</span> <span class="co"># , # São Paulo</span></span>
<span>  <span class="co"># 2507507, # João Pessoa</span></span>
<span>  <span class="co"># 3106200, # Belo Horizonte</span></span>
<span>  <span class="co"># 4314902, # Porto Alegre</span></span>
<span>  <span class="co"># 1721000, # Palmas</span></span>
<span>  <span class="co"># 5300108, # Brasília</span></span>
<span>  <span class="co"># 5208707  # Goiânia</span></span>
<span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section></section><section id="download-cnae-classification-table" class="level2"><h2 class="anchored" data-anchor-id="download-cnae-classification-table">Download CNAE Classification Table</h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">classification_data</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://googlesheets4.tidyverse.org/reference/range_read.html">read_sheet</a></span><span class="op">(</span></span>
<span>    ss <span class="op">=</span> <span class="st">"1ipCw2FM3aUOdRd4w55J5SUEgXDCogxWZF-NZi0A-o_4"</span>,</span>
<span>    sheet <span class="op">=</span> <span class="st">"Dataset"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    g0 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span></span>
<span>      <span class="va">g1_g2</span> <span class="op">==</span> <span class="cn">TRUE</span> <span class="op">&amp;</span> <span class="va">g3</span> <span class="op">==</span> <span class="cn">FALSE</span> <span class="op">&amp;</span> <span class="va">g4</span> <span class="op">==</span> <span class="cn">FALSE</span>,</span>
<span>      <span class="cn">TRUE</span>,</span>
<span>      <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; ✔ Reading from "Locais-Nova By CNAE".</span></span>
<span><span class="co">#&gt; ✔ Range ''Dataset''.</span></span>
<span></span>
<span><span class="va">classification_data</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 540</span></span>
<span><span class="co">#&gt; Columns: 7</span></span>
<span><span class="co">#&gt; $ cnae         &lt;chr&gt; "4711302", "5611201", "4722902", "4721102", "4721101",…</span></span>
<span><span class="co">#&gt; $ description  &lt;chr&gt; "Supermarket 1", "Restaurant", "Fish Market", "Bakery …</span></span>
<span><span class="co">#&gt; $ federal_unit &lt;chr&gt; "AC", "AC", "AC", "AC", "AC", "AC", "AC", "AC", "AC", …</span></span>
<span><span class="co">#&gt; $ g0           &lt;lgl&gt; FALSE, TRUE, TRUE, FALSE, FALSE, FALSE, FALSE, FALSE, …</span></span>
<span><span class="co">#&gt; $ g1_g2        &lt;lgl&gt; TRUE, TRUE, TRUE, FALSE, FALSE, FALSE, FALSE, FALSE, F…</span></span>
<span><span class="co">#&gt; $ g3           &lt;lgl&gt; FALSE, FALSE, FALSE, TRUE, TRUE, FALSE, FALSE, TRUE, F…</span></span>
<span><span class="co">#&gt; $ g4           &lt;lgl&gt; TRUE, FALSE, FALSE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE…</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section><section id="download-data-on-brazilian-agencies-and-municipalities" class="level2"><h2 class="anchored" data-anchor-id="download-data-on-brazilian-agencies-and-municipalities">Download Data on Brazilian Agencies and Municipalities</h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">url</span> <span class="op">&lt;-</span> <span class="st">"https://www.gov.br/receitafederal/dados/municipios.csv"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://jeroen.r-universe.dev/curl/reference/curl_download.html">curl_download</a></span><span class="op">(</span><span class="va">url</span>, destfile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">raw_data_dir</span>, <span class="st">"municipios.csv"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section><section id="download-the-rfb-raw-data" class="level2"><h2 class="anchored" data-anchor-id="download-the-rfb-raw-data">Download the RFB Raw Data</h2>
<section id="set-parameters" class="level3"><h3 class="anchored" data-anchor-id="set-parameters">Set Parameters</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://fs.r-lib.org/reference/file_access.html">dir_exists</a></span><span class="op">(</span><span class="va">raw_data_dir</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://fs.r-lib.org/reference/delete.html">dir_delete</a></span><span class="op">(</span><span class="va">raw_data_dir</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://fs.r-lib.org/reference/create.html">dir_create</a></span><span class="op">(</span><span class="va">raw_data_dir</span>, recurse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section><section id="download-files" class="level3"><h3 class="anchored" data-anchor-id="download-files">Download Files</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">root</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span> <span class="co"># Don´t change the function!</span></span>
<span>    <span class="st">"https://arquivos.receitafederal.gov.br"</span>,</span>
<span>    <span class="st">"dados"</span>,</span>
<span>    <span class="st">"cnpj"</span>,</span>
<span>    <span class="st">"dados_abertos_cnpj"</span></span>
<span>  <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">path</span> <span class="op">&lt;-</span> <span class="va">root</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"2025-"</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_pad.html">str_pad</a></span><span class="op">(</span><span class="va">month</span>, <span class="fl">2</span>, pad <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">urls</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">path</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="http://xml2.r-lib.org/reference/read_xml.html">read_html</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_element.html">html_elements</a></span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rvest.tidyverse.org/reference/html_attr.html">html_attr</a></span><span class="op">(</span><span class="st">"href"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_subset.html">str_subset</a></span><span class="op">(</span><span class="st">"\\.zip$"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">path</span>, <span class="va">.</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">urls</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span>.f <span class="op">=</span> <span class="va">get_file_size</span>, .progress <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://fs.r-lib.org/reference/fs_bytes.html">as_fs_bytes</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; 6.26G</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">urls</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://danielvartan.github.io/rutils/reference/download_file.html">download_file</a></span><span class="op">(</span>dir <span class="op">=</span> <span class="va">raw_data_dir</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section><section id="unzip-files" class="level3"><h3 class="anchored" data-anchor-id="unzip-files">Unzip Files</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">zip_files</span> <span class="op">&lt;-</span> <span class="va">raw_data_dir</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html">dir_ls</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"file"</span>, regexp <span class="op">=</span> <span class="st">"\\.zip$"</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">zip_files</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span>\<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://r-lib.github.io/zip/reference/unzip.html">unzip</a></span><span class="op">(</span><span class="va">x</span>, exdir <span class="op">=</span> <span class="va">raw_data_dir</span><span class="op">)</span>, .progress <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">zip_files</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://fs.r-lib.org/reference/delete.html">file_delete</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section></section><section id="read-tom-municipality-codes" class="level2"><h2 class="anchored" data-anchor-id="read-tom-municipality-codes">Read TOM Municipality Codes</h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">municipalities_tom_data</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">raw_data_dir</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://fs.r-lib.org/reference/path.html">path</a></span><span class="op">(</span><span class="st">"municipios.csv"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_delim</a></span><span class="op">(</span></span>
<span>    delim <span class="op">=</span> <span class="st">";"</span>,</span>
<span>    col_names <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    col_types <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/cols.html">cols</a></span><span class="op">(</span>.default <span class="op">=</span> <span class="st">"c"</span><span class="op">)</span>,</span>
<span>    progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span></span>
<span>      .cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      .fns <span class="op">=</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/iconv.html">iconv</a></span><span class="op">(</span><span class="va">x</span>, from <span class="op">=</span> <span class="st">"Windows-1252"</span>, to <span class="op">=</span> <span class="st">"UTF-8"</span><span class="op">)</span> <span class="co"># iconvlist()</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename_with</a></span><span class="op">(</span></span>
<span>    \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"municipality_code_tom"</span>,</span>
<span>    <span class="st">"municipality_code_ibge"</span>,</span>
<span>    <span class="st">"municipality_tom"</span>,</span>
<span>    <span class="st">"municipality_ibge"</span>,</span>
<span>    <span class="st">"uf"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    municipality_code_tom <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">municipality_code_tom</span><span class="op">)</span>,</span>
<span>    municipality_code_ibge <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">municipality_code_ibge</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">municipalities_tom_data</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 5,571</span></span>
<span><span class="co">#&gt; Columns: 5</span></span>
<span><span class="co">#&gt; $ municipality_code_tom  &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 1…</span></span>
<span><span class="co">#&gt; $ municipality_code_ibge &lt;int&gt; 1100106, 1100379, 1100205, 1100452, 1100122,…</span></span>
<span><span class="co">#&gt; $ municipality_tom       &lt;chr&gt; "GUAJARÁ-MIRIM", "ALTO ALEGRE DOS PARECIS", …</span></span>
<span><span class="co">#&gt; $ municipality_ibge      &lt;chr&gt; "Guajará-Mirim", "Alto Alegre dos Parecis", …</span></span>
<span><span class="co">#&gt; $ uf                     &lt;chr&gt; "RO", "RO", "RO", "RO", "RO", "RO", "RO", "R…</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section><section id="replace-ibge-municipality-codes-with-tom-codes" class="level2"><h2 class="anchored" data-anchor-id="replace-ibge-municipality-codes-with-tom-codes">Replace IBGE Municipality Codes with TOM Codes</h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">municipalities</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">municipalities_tom_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">municipality_code_ibge</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">municipalities</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="va">municipality_code_tom</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">municipalities</span></span>
<span><span class="co">#&gt; [1] 7107</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section><section id="read-the-data" class="level2"><h2 class="anchored" data-anchor-id="read-the-data">Read the Data</h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">establishment_data</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">raw_data_dir</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html">dir_ls</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"file"</span>, regexp <span class="op">=</span> <span class="st">"\\.ESTABELE$"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span></span>
<span>    <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://vroom.r-lib.org/reference/vroom.html">vroom</a></span><span class="op">(</span></span>
<span>        <span class="co"># Uses `pipe()` and `awk` to filter data to avoid loading the</span></span>
<span>        <span class="co"># entire file into memory.</span></span>
<span>        file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/connections.html">pipe</a></span><span class="op">(</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span></span>
<span>            <span class="st">"awk "</span>,</span>
<span>            <span class="st">"-F "</span>,</span>
<span>            <span class="st">"';' "</span>,</span>
<span>            <span class="st">"'{ "</span>,</span>
<span>            <span class="st">"if ("</span>,</span>
<span>            <span class="st">'$6 == "'</span>, <span class="st">'\\"02\\"'</span>, <span class="st">'"'</span>,</span>
<span>            <span class="st">" &amp;&amp; "</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">'$21 == "\\"'</span>, <span class="va">municipalities</span>, <span class="st">'\\""'</span>, collapse <span class="op">=</span> <span class="st">" || "</span><span class="op">)</span>,</span>
<span>            <span class="st">") "</span>,</span>
<span>            <span class="st">"print"</span>,</span>
<span>            <span class="st">" }' "</span>,</span>
<span>            <span class="va">x</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span>,</span>
<span>        delim <span class="op">=</span> <span class="st">";"</span>,</span>
<span>        col_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>          <span class="st">"cnpj_basic"</span>,</span>
<span>          <span class="st">"cnpj_order"</span>,</span>
<span>          <span class="st">"cnpj_dv"</span>,</span>
<span>          <span class="st">"branch_identifier"</span>,</span>
<span>          <span class="st">"trade_name"</span>,</span>
<span>          <span class="st">"registration_status"</span>,</span>
<span>          <span class="st">"registration_status_date"</span>,</span>
<span>          <span class="st">"registration_status_reason"</span>,</span>
<span>          <span class="st">"foreign_city_name"</span>,</span>
<span>          <span class="st">"country"</span>,</span>
<span>          <span class="st">"start_date"</span>,</span>
<span>          <span class="st">"cnae_primary"</span>,</span>
<span>          <span class="st">"cnae_secondary"</span>,</span>
<span>          <span class="st">"street_type"</span>,</span>
<span>          <span class="st">"street_name"</span>,</span>
<span>          <span class="st">"number"</span>,</span>
<span>          <span class="st">"address_complement"</span>,</span>
<span>          <span class="st">"neighborhood"</span>,</span>
<span>          <span class="st">"postal_code"</span>,</span>
<span>          <span class="st">"federal_unit"</span>,</span>
<span>          <span class="st">"municipality_code_tom"</span>,</span>
<span>          <span class="st">"phone_area_code_1"</span>,</span>
<span>          <span class="st">"phone_number_1"</span>,</span>
<span>          <span class="st">"phone_area_code_2"</span>,</span>
<span>          <span class="st">"phone_number_2"</span>,</span>
<span>          <span class="st">"fax_area_code"</span>,</span>
<span>          <span class="st">"fax_number"</span>,</span>
<span>          <span class="st">"email"</span>,</span>
<span>          <span class="st">"special_status"</span>,</span>
<span>          <span class="st">"special_status_date"</span></span>
<span>        <span class="op">)</span>,</span>
<span>        col_types <span class="op">=</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/cols.html">cols</a></span><span class="op">(</span>.default <span class="op">=</span> <span class="st">"c"</span><span class="op">)</span>,</span>
<span>        col_select <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>          <span class="st">"cnpj_basic"</span>, <span class="st">"cnpj_order"</span>, <span class="st">"cnpj_dv"</span>, <span class="st">"cnae_primary"</span>,</span>
<span>          <span class="st">"federal_unit"</span>, <span class="st">"municipality_code_tom"</span>, <span class="st">"street_type"</span>,</span>
<span>          <span class="st">"street_name"</span>, <span class="st">"number"</span>, <span class="st">"address_complement"</span>, <span class="st">"neighborhood"</span>,</span>
<span>          <span class="st">"postal_code"</span></span>
<span>        <span class="op">)</span>,</span>
<span>        show_col_types <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    .progress <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/list_c.html">list_rbind</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;  ■■■■                              10% |  ETA:  5m</span></span>
<span><span class="co">#&gt;  ■■■■■■■                           20% |  ETA:  2m</span></span>
<span><span class="co">#&gt;  ■■■■■■■■■■                        30% |  ETA:  2m</span></span>
<span><span class="co">#&gt;  ■■■■■■■■■■■■■                     40% |  ETA:  1m</span></span>
<span><span class="co">#&gt;  ■■■■■■■■■■■■■■■■                  50% |  ETA:  1m</span></span>
<span><span class="co">#&gt;  ■■■■■■■■■■■■■■■■■■■               60% |  ETA: 46s</span></span>
<span><span class="co">#&gt;  ■■■■■■■■■■■■■■■■■■■■■■            70% |  ETA: 32s</span></span>
<span><span class="co">#&gt;  ■■■■■■■■■■■■■■■■■■■■■■■■■         80% |  ETA: 21s</span></span>
<span><span class="co">#&gt;  ■■■■■■■■■■■■■■■■■■■■■■■■■■■■      90% |  ETA: 10s</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">establishment_data</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 2,199,116</span></span>
<span><span class="co">#&gt; Columns: 12</span></span>
<span><span class="co">#&gt; $ cnpj_basic            &lt;chr&gt; "33522741", "30943196", "37895692", "35228854…</span></span>
<span><span class="co">#&gt; $ cnpj_order            &lt;chr&gt; "0001", "0001", "0001", "0001", "0001", "0001…</span></span>
<span><span class="co">#&gt; $ cnpj_dv               &lt;chr&gt; "91", "19", "93", "04", "60", "57", "50", "98…</span></span>
<span><span class="co">#&gt; $ cnae_primary          &lt;chr&gt; "4520001", "3101200", "4781400", "9602502", "…</span></span>
<span><span class="co">#&gt; $ federal_unit          &lt;chr&gt; "SP", "SP", "SP", "SP", "SP", "SP", "SP", "SP…</span></span>
<span><span class="co">#&gt; $ municipality_code_tom &lt;chr&gt; "7107", "7107", "7107", "7107", "7107", "7107…</span></span>
<span><span class="co">#&gt; $ street_type           &lt;chr&gt; "RUA", "RUA", "RUA", "AVENIDA", "RUA", "RUA",…</span></span>
<span><span class="co">#&gt; $ street_name           &lt;chr&gt; "WERNER VON SIEMENS", "CARLOS VILLALVA", "BAD…</span></span>
<span><span class="co">#&gt; $ number                &lt;chr&gt; "111", "151", "136", "105", "404", "343", "70…</span></span>
<span><span class="co">#&gt; $ address_complement    &lt;chr&gt; NA, "APT   22", NA, "EDIF THERA BERRINI OFFIC…</span></span>
<span><span class="co">#&gt; $ neighborhood          &lt;chr&gt; "LAPA DE BAIXO", "VILA GUARANI (Z SUL)", "JAR…</span></span>
<span><span class="co">#&gt; $ postal_code           &lt;chr&gt; "05069900", "04307000", "03715070", "04571900…</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section><section id="filter-the-data" class="level2"><h2 class="anchored" data-anchor-id="filter-the-data">Filter the Data</h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">establishment_data</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">establishment_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>cnae <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_pad.html">str_pad</a></span><span class="op">(</span><span class="va">cnae_primary</span>, <span class="fl">7</span>, pad <span class="op">=</span> <span class="st">"0"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">classification_data</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cnae"</span>, <span class="st">"federal_unit"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://danielvartan.github.io/rutils/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="va">g0</span>, <span class="va">g1_g2</span>, <span class="va">g3</span>, <span class="va">g4</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">establishment_data</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 147,096</span></span>
<span><span class="co">#&gt; Columns: 18</span></span>
<span><span class="co">#&gt; $ cnpj_basic            &lt;chr&gt; "37855854", "37857237", "37863142", "37868873…</span></span>
<span><span class="co">#&gt; $ cnpj_order            &lt;chr&gt; "0001", "0001", "0001", "0001", "0001", "0001…</span></span>
<span><span class="co">#&gt; $ cnpj_dv               &lt;chr&gt; "60", "01", "92", "20", "22", "80", "04", "43…</span></span>
<span><span class="co">#&gt; $ cnae_primary          &lt;chr&gt; "5620104", "5620104", "5620104", "5620104", "…</span></span>
<span><span class="co">#&gt; $ federal_unit          &lt;chr&gt; "SP", "SP", "SP", "SP", "SP", "SP", "SP", "SP…</span></span>
<span><span class="co">#&gt; $ municipality_code_tom &lt;chr&gt; "7107", "7107", "7107", "7107", "7107", "7107…</span></span>
<span><span class="co">#&gt; $ street_type           &lt;chr&gt; "RUA", "RUA", "RUA", "RUA", "RUA", "RUA", "RU…</span></span>
<span><span class="co">#&gt; $ street_name           &lt;chr&gt; "DO TRABALHO", "GIOVANNI DI PAOLO", "ANTONIO …</span></span>
<span><span class="co">#&gt; $ number                &lt;chr&gt; "404", "155", "115", "155", "61", "86", "208"…</span></span>
<span><span class="co">#&gt; $ address_complement    &lt;chr&gt; "CONJ 11", NA, NA, "CONJ 142", NA, NA, NA, "F…</span></span>
<span><span class="co">#&gt; $ neighborhood          &lt;chr&gt; "VILA NOVA SAVOIA", "AGUA FUNDA", "JARDIM ITA…</span></span>
<span><span class="co">#&gt; $ postal_code           &lt;chr&gt; "03531010", "04156100", "04386020", "03084030…</span></span>
<span><span class="co">#&gt; $ cnae                  &lt;chr&gt; "5620104", "5620104", "5620104", "5620104", "…</span></span>
<span><span class="co">#&gt; $ description           &lt;chr&gt; "Home‑Meal Delivery", "Home‑Meal Delivery", "…</span></span>
<span><span class="co">#&gt; $ g0                    &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, TRUE, FALS…</span></span>
<span><span class="co">#&gt; $ g1_g2                 &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, TRUE, FALS…</span></span>
<span><span class="co">#&gt; $ g3                    &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FAL…</span></span>
<span><span class="co">#&gt; $ g4                    &lt;lgl&gt; TRUE, TRUE, TRUE, TRUE, TRUE, FALSE, TRUE, TR…</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section><section id="tidy-the-data" class="level2"><h2 class="anchored" data-anchor-id="tidy-the-data">Tidy the Data</h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">establishment_data</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">establishment_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>municipality_code_tom <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">as.integer</a></span><span class="op">(</span><span class="va">municipality_code_tom</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">municipalities_tom_data</span>, by <span class="op">=</span> <span class="st">"municipality_code_tom"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span></span>
<span>    municipality_code <span class="op">=</span> <span class="va">municipality_code_ibge</span>,</span>
<span>    municipality <span class="op">=</span> <span class="va">municipality_ibge</span>,</span>
<span>    complement <span class="op">=</span> <span class="va">address_complement</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    cnpj_basic <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_pad.html">str_pad</a></span><span class="op">(</span><span class="va">cnpj_basic</span>, <span class="fl">8</span>, pad <span class="op">=</span> <span class="st">"0"</span><span class="op">)</span>,</span>
<span>    cnpj_order <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_pad.html">str_pad</a></span><span class="op">(</span><span class="va">cnpj_order</span>, <span class="fl">4</span>, pad <span class="op">=</span> <span class="st">"0"</span><span class="op">)</span>,</span>
<span>    cnpj_dv <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_pad.html">str_pad</a></span><span class="op">(</span><span class="va">cnpj_dv</span>, <span class="fl">2</span>, pad <span class="op">=</span> <span class="st">"0"</span><span class="op">)</span>,</span>
<span>    cnpj <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">cnpj_basic</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>      <span class="st">"."</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">cnpj_basic</span>, <span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>      <span class="st">"."</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">cnpj_basic</span>, <span class="fl">6</span>, <span class="fl">8</span><span class="op">)</span>,</span>
<span>      <span class="st">"/"</span>, <span class="va">cnpj_order</span>,</span>
<span>      <span class="st">"-"</span>, <span class="va">cnpj_dv</span></span>
<span>    <span class="op">)</span>,</span>
<span>    cnae <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">cnae</span>, <span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>      <span class="st">"-"</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">cnae</span>, <span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>      <span class="st">"/"</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">cnae</span>, <span class="fl">6</span>, <span class="fl">7</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    street_type <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_title</a></span><span class="op">(</span><span class="va">street_type</span><span class="op">)</span>,</span>
<span>    street_name <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_title</a></span><span class="op">(</span><span class="va">street_name</span><span class="op">)</span>,</span>
<span>    address <span class="op">=</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">street_type</span>, <span class="va">street_name</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/iconv.html">iconv</a></span><span class="op">(</span>to <span class="op">=</span> <span class="st">"ASCII//TRANSLIT"</span><span class="op">)</span>,</span>
<span>    number <span class="op">=</span></span>
<span>      <span class="va">number</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/iconv.html">iconv</a></span><span class="op">(</span>to <span class="op">=</span> <span class="st">"ASCII//TRANSLIT"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html">str_remove_all</a></span><span class="op">(</span><span class="st">"\\D"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_trim.html">str_trim</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    complement <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_title</a></span><span class="op">(</span><span class="va">complement</span><span class="op">)</span>,</span>
<span>    neighborhood <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_title</a></span><span class="op">(</span><span class="va">neighborhood</span><span class="op">)</span>,</span>
<span>    postal_code <span class="op">=</span></span>
<span>      <span class="va">postal_code</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_pad.html">str_pad</a></span><span class="op">(</span>pad <span class="op">=</span> <span class="fl">0</span>, width <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span></span>
<span>    <span class="va">cnpj</span>, <span class="va">cnae</span>,</span>
<span>    <span class="va">federal_unit</span>, <span class="va">municipality_code</span>, <span class="va">municipality</span>,</span>
<span>    <span class="va">address</span>, <span class="va">number</span>, <span class="va">complement</span>, <span class="va">neighborhood</span>, <span class="va">postal_code</span>,</span>
<span>    <span class="va">g0</span>, <span class="va">g1_g2</span>, <span class="va">g3</span>, <span class="va">g4</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span></span>
<span>      .cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/where.html">where</a></span><span class="op">(</span><span class="va">is.character</span><span class="op">)</span>,</span>
<span>      .fns <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/Encoding.html">Encoding</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"UTF-8"</span></span>
<span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/iconv.html">iconv</a></span><span class="op">(</span><span class="va">x</span>, from <span class="op">=</span> <span class="st">""</span>, to <span class="op">=</span> <span class="st">"UTF-8"</span>, sub <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">establishment_data</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 147,096</span></span>
<span><span class="co">#&gt; Columns: 14</span></span>
<span><span class="co">#&gt; $ cnpj              &lt;chr&gt; "37.855.854/0001-60", "37.857.237/0001-01", "37.8…</span></span>
<span><span class="co">#&gt; $ cnae              &lt;chr&gt; "5620-1/04", "5620-1/04", "5620-1/04", "5620-1/04…</span></span>
<span><span class="co">#&gt; $ federal_unit      &lt;chr&gt; "SP", "SP", "SP", "SP", "SP", "SP", "SP", "SP", "…</span></span>
<span><span class="co">#&gt; $ municipality_code &lt;int&gt; 3550308, 3550308, 3550308, 3550308, 3550308, 3550…</span></span>
<span><span class="co">#&gt; $ municipality      &lt;chr&gt; "São Paulo", "São Paulo", "São Paulo", "São Paulo…</span></span>
<span><span class="co">#&gt; $ address           &lt;chr&gt; "Rua Do Trabalho", "Rua Giovanni Di Paolo", "Rua …</span></span>
<span><span class="co">#&gt; $ number            &lt;chr&gt; "404", "155", "115", "155", "61", "86", "208", "4…</span></span>
<span><span class="co">#&gt; $ complement        &lt;chr&gt; "Conj 11", NA, NA, "Conj 142", NA, NA, NA, "Fundo…</span></span>
<span><span class="co">#&gt; $ neighborhood      &lt;chr&gt; "Vila Nova Savoia", "Agua Funda", "Jardim Itacolo…</span></span>
<span><span class="co">#&gt; $ postal_code       &lt;chr&gt; "03531010", "04156100", "04386020", "03084030", "…</span></span>
<span><span class="co">#&gt; $ g0                &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, TRUE, FALSE, F…</span></span>
<span><span class="co">#&gt; $ g1_g2             &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, TRUE, FALSE, F…</span></span>
<span><span class="co">#&gt; $ g3                &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, …</span></span>
<span><span class="co">#&gt; $ g4                &lt;lgl&gt; TRUE, TRUE, TRUE, TRUE, TRUE, FALSE, TRUE, TRUE, …</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section><section id="arrange-the-data" class="level2"><h2 class="anchored" data-anchor-id="arrange-the-data">Arrange the Data</h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">establishment_data</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">establishment_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">federal_unit</span>, <span class="va">municipality</span>, <span class="va">cnae</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">establishment_data</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 147,096</span></span>
<span><span class="co">#&gt; Columns: 14</span></span>
<span><span class="co">#&gt; $ cnpj              &lt;chr&gt; "06.057.223/0430-67", "75.315.333/0338-99", "76.4…</span></span>
<span><span class="co">#&gt; $ cnae              &lt;chr&gt; "4711-3/01", "4711-3/01", "4711-3/01", "4711-3/01…</span></span>
<span><span class="co">#&gt; $ federal_unit      &lt;chr&gt; "SP", "SP", "SP", "SP", "SP", "SP", "SP", "SP", "…</span></span>
<span><span class="co">#&gt; $ municipality_code &lt;int&gt; 3550308, 3550308, 3550308, 3550308, 3550308, 3550…</span></span>
<span><span class="co">#&gt; $ municipality      &lt;chr&gt; "São Paulo", "São Paulo", "São Paulo", "São Paulo…</span></span>
<span><span class="co">#&gt; $ address           &lt;chr&gt; "Rua Nsra Das Merces", "Avenida Jose Cesar De Oli…</span></span>
<span><span class="co">#&gt; $ number            &lt;chr&gt; "29", "500", "519", "500", "1535", "2979", "899",…</span></span>
<span><span class="co">#&gt; $ complement        &lt;chr&gt; NA, "Anexo A", NA, "Box   20", NA, NA, NA, NA, NA…</span></span>
<span><span class="co">#&gt; $ neighborhood      &lt;chr&gt; "Vila Das Merces", "Vila Leopoldina", "Jardim Per…</span></span>
<span><span class="co">#&gt; $ postal_code       &lt;chr&gt; "04165000", "05317000", "05536900", "02049900", "…</span></span>
<span><span class="co">#&gt; $ g0                &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, …</span></span>
<span><span class="co">#&gt; $ g1_g2             &lt;lgl&gt; TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, T…</span></span>
<span><span class="co">#&gt; $ g3                &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, …</span></span>
<span><span class="co">#&gt; $ g4                &lt;lgl&gt; TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, T…</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section><section id="geocode-the-data" class="level2"><h2 class="anchored" data-anchor-id="geocode-the-data">Geocode the Data</h2>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">fields</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ipeagit.github.io/geocodebr/reference/definir_campos.html">definir_campos</a></span><span class="op">(</span></span>
<span>  estado <span class="op">=</span> <span class="st">"federal_unit"</span>,</span>
<span>  municipio <span class="op">=</span> <span class="st">"municipality_code"</span>,</span>
<span>  logradouro <span class="op">=</span> <span class="st">"address"</span>,</span>
<span>  numero <span class="op">=</span> <span class="st">"number"</span>,</span>
<span>  cep <span class="op">=</span> <span class="st">"postal_code"</span>,</span>
<span>  localidade <span class="op">=</span> <span class="st">"neighborhood"</span></span>
<span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">establishment_data</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">establishment_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ipeagit.github.io/geocodebr/reference/geocode.html">geocode</a></span><span class="op">(</span></span>
<span>    campos_endereco <span class="op">=</span> <span class="va">fields</span>,</span>
<span>    resultado_sf <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    verboso <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    cache <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    n_cores <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    resolver_empates <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; ℹ Padronizando endereços de entrada</span></span>
<span><span class="co">#&gt; ℹ Utilizando dados do CNEFE armazenados localmente</span></span>
<span><span class="co">#&gt; ℹ Geolocalizando endereços</span></span>
<span><span class="co">#&gt; Endereços processados: 0/147,096 ■                                  0% - Pro…</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Endereços processados: 36,079/147,096 ■■■■■■■■                          25% …</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Endereços processados: 66,072/147,096 ■■■■■■■■■■■■■■                    45% …</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Endereços processados: 67,900/147,096 ■■■■■■■■■■■■■■■                   46% …</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Endereços processados: 69,904/147,096 ■■■■■■■■■■■■■■■                   48% …</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Endereços processados: 115,800/147,096 ■■■■■■■■■■■■■■■■■■■■■■■■■         79%…</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Endereços processados: 131,829/147,096 ■■■■■■■■■■■■■■■■■■■■■■■■■■■■      90%…</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Endereços processados: 133,277/147,096 ■■■■■■■■■■■■■■■■■■■■■■■■■■■■      91%…</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Endereços processados: 134,009/147,096 ■■■■■■■■■■■■■■■■■■■■■■■■■■■■      91%…</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Endereços processados: 135,240/147,096 ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■     92%…</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Endereços processados: 136,456/147,096 ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■     93%…</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Endereços processados: 136,629/147,096 ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■     93%…</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Endereços processados: 136,970/147,096 ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■     93%…</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Endereços processados: 138,250/147,096 ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■     94%…</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Endereços processados: 139,066/147,096 ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■     95%…</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Endereços processados: 139,768/147,096 ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■    95%…</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Endereços processados: 139,797/147,096 ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■    95%…</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Endereços processados: 140,416/147,096 ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■    95%…</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Endereços processados: 140,442/147,096 ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■    95%…</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Endereços processados: 140,483/147,096 ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■    96%…</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Endereços processados: 140,489/147,096 ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■    96%…</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Endereços processados: 140,532/147,096 ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■    96%…</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Endereços processados: 142,703/147,096 ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■    97%…</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Endereços processados: 146,139/147,096 ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■   99%…</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Endereços processados: 146,822/147,096 ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■  100%…</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Endereços processados: 147,096/147,096 ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■  100%…</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ℹ Preparando resultados</span></span>
<span><span class="co">#&gt; Foram encontrados e resolvidos 4638 casos de empate.</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">establishment_data</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">establishment_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span></span>
<span>    latitude <span class="op">=</span> <span class="va">lat</span>,</span>
<span>    longitude <span class="op">=</span> <span class="va">lon</span>,</span>
<span>    geocodebr_precision <span class="op">=</span> <span class="va">precisao</span>,</span>
<span>    geocodebr_type_of_result <span class="op">=</span> <span class="va">tipo_resultado</span>,</span>
<span>    geocodebr_deviation_meters <span class="op">=</span> <span class="va">desvio_metros</span>,</span>
<span>    geocodebr_address_found <span class="op">=</span> <span class="va">endereco_encontrado</span>,</span>
<span>    geocodebr_ambiguous <span class="op">=</span> <span class="va">empate</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html">relocate</a></span><span class="op">(</span><span class="va">g0</span>, <span class="va">g1_g2</span>, <span class="va">g3</span>, <span class="va">g4</span>, .after <span class="op">=</span> <span class="va">geocodebr_ambiguous</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://danielvartan.github.io/rutils/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"latitude"</span>, <span class="st">"longitude"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">establishment_data</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 147,096</span></span>
<span><span class="co">#&gt; Columns: 21</span></span>
<span><span class="co">#&gt; $ cnpj                       &lt;chr&gt; "06.057.223/0430-67", "75.315.333/0338-9…</span></span>
<span><span class="co">#&gt; $ cnae                       &lt;chr&gt; "4711-3/01", "4711-3/01", "4711-3/01", "…</span></span>
<span><span class="co">#&gt; $ federal_unit               &lt;chr&gt; "SP", "SP", "SP", "SP", "SP", "SP", "SP"…</span></span>
<span><span class="co">#&gt; $ municipality_code          &lt;int&gt; 3550308, 3550308, 3550308, 3550308, 3550…</span></span>
<span><span class="co">#&gt; $ municipality               &lt;chr&gt; "São Paulo", "São Paulo", "São Paulo", "…</span></span>
<span><span class="co">#&gt; $ address                    &lt;chr&gt; "Rua Nsra Das Merces", "Avenida Jose Ces…</span></span>
<span><span class="co">#&gt; $ number                     &lt;chr&gt; "29", "500", "519", "500", "1535", "2979…</span></span>
<span><span class="co">#&gt; $ complement                 &lt;chr&gt; NA, "Anexo A", NA, "Box   20", NA, NA, N…</span></span>
<span><span class="co">#&gt; $ neighborhood               &lt;chr&gt; "Vila Das Merces", "Vila Leopoldina", "J…</span></span>
<span><span class="co">#&gt; $ postal_code                &lt;chr&gt; "04165000", "05317000", "05536900", "020…</span></span>
<span><span class="co">#&gt; $ latitude                   &lt;dbl&gt; -23.62285201, -23.54093647, -23.58904585…</span></span>
<span><span class="co">#&gt; $ longitude                  &lt;dbl&gt; -46.60754656, -46.73186811, -46.73859387…</span></span>
<span><span class="co">#&gt; $ geocodebr_precision        &lt;chr&gt; "cep", "numero", "numero_aproximado", "n…</span></span>
<span><span class="co">#&gt; $ geocodebr_type_of_result   &lt;chr&gt; "dc01", "dn01", "da04", "dn03", "da01", …</span></span>
<span><span class="co">#&gt; $ geocodebr_deviation_meters &lt;int&gt; 141, 342, 8, 6, 6, 6, 6, 6, 6, 1878, 6, …</span></span>
<span><span class="co">#&gt; $ geocodebr_address_found    &lt;chr&gt; "VILA DAS MERCES, SAO PAULO - SP, 04165-…</span></span>
<span><span class="co">#&gt; $ geocodebr_ambiguous        &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE…</span></span>
<span><span class="co">#&gt; $ g0                         &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE…</span></span>
<span><span class="co">#&gt; $ g1_g2                      &lt;lgl&gt; TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE…</span></span>
<span><span class="co">#&gt; $ g3                         &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE…</span></span>
<span><span class="co">#&gt; $ g4                         &lt;lgl&gt; TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE…</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section><section id="data-dictionary" class="level2"><h2 class="anchored" data-anchor-id="data-dictionary">Data Dictionary</h2>
</section><section id="save-the-valid-data" class="level2"><h2 class="anchored" data-anchor-id="save-the-valid-data">Save the Valid Data</h2>
</section><section id="visualize-the-data" class="level2"><h2 class="anchored" data-anchor-id="visualize-the-data">Visualize the Data</h2>
<section id="set-variables" class="level3"><h3 class="anchored" data-anchor-id="set-variables">Set Variables</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_municipality</span> <span class="op">&lt;-</span> <span class="fl">3550308</span> <span class="co"># São Paulo</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section><section id="set-shape" class="level3"><h3 class="anchored" data-anchor-id="set-shape">Set Shape</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">shape</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">plot_municipality</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ipeagit.github.io/geobr/reference/read_municipality.html">read_municipality</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://danielvartan.github.io/orbis/reference/closest_geobr_year.html">closest_geobr_year</a></span><span class="op">(</span><span class="va">year</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="fl">4326</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; ! The closest map year to 2025 is 2020. Using year 2020 instead.</span></span>
<span><span class="co">#&gt; Using year/date 2020</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section><section id="prepare-data" class="level3"><h3 class="anchored" data-anchor-id="prepare-data">Prepare Data</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_data</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">establishment_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">municipality_code</span> <span class="op">==</span> <span class="va">plot_municipality</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span></span>
<span>    cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"g0"</span>, <span class="st">"g1_g2"</span>, <span class="st">"g3"</span>, <span class="st">"g4"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    names_to <span class="op">=</span> <span class="st">"group"</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">"value"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">value</span> <span class="op">==</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span></span>
<span>    coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"longitude"</span>, <span class="st">"latitude"</span><span class="op">)</span>,</span>
<span>    crs <span class="op">=</span> <span class="fl">4326</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_join.html">st_join</a></span><span class="op">(</span><span class="va">shape</span>, join <span class="op">=</span> <span class="va">st_within</span>, left <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    latitude <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>,</span>
<span>    longitude <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_coordinates.html">st_coordinates</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html">transmute</a></span><span class="op">(</span></span>
<span>    group <span class="op">=</span></span>
<span>      <span class="va">group</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://stringr.tidyverse.org/reference/case.html">str_to_upper</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace</a></span><span class="op">(</span><span class="st">"_"</span>, <span class="st">"-"</span><span class="op">)</span>,</span>
<span>    <span class="va">latitude</span>,</span>
<span>    <span class="va">longitude</span></span>
<span>  <span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">plot_data</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html">glimpse</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 204,645</span></span>
<span><span class="co">#&gt; Columns: 3</span></span>
<span><span class="co">#&gt; $ group     &lt;chr&gt; "G1-G2", "G4", "G1-G2", "G4", "G1-G2", "G4", "G1-G2", "G4…</span></span>
<span><span class="co">#&gt; $ latitude  &lt;dbl&gt; -23.62285201, -23.62285201, -23.54093647, -23.54093647, -…</span></span>
<span><span class="co">#&gt; $ longitude &lt;dbl&gt; -46.60754656, -46.60754656, -46.73186811, -46.73186811, -…</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section><section id="plot-data" class="level3"><h3 class="anchored" data-anchor-id="plot-data">Plot Data</h3>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">shape</span>,</span>
<span>    fill <span class="op">=</span> <span class="st">"gray90"</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"black"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">plot_data</span>,</span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">longitude</span>, y <span class="op">=</span> <span class="va">latitude</span>, color <span class="op">=</span> <span class="va">group</span><span class="op">)</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">0.01</span></span>
<span>    <span class="co"># color = get_brand_color("blue")</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">group</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="cn">NULL</span>, breaks <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="cn">NULL</span>, breaks <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://danielvartan.github.io/brandr/reference/scale_brand.html">scale_colour_brand_d</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="cn">NULL</span>, color <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><a href="index_files/figure-html/Test Plot-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="index_files/figure-html/Test Plot-1.png" class="img-fluid figure-img" width="960"></a></p>
</figure>
</div>
</div>
</div>
</section></section><section id="citation" class="level2"><h2 class="anchored" data-anchor-id="citation">Citation</h2>
<div class="callout callout-style-simple callout-important">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>When using this data, you must also cite the original data sources.</p>
</div>
</div>
</div>
<p>To cite this work, please use the following format:</p>
<p>Vartanian, D., Penz, C. L. S., Caldeira, G., Fernandes, C. N., &amp; Giannotti, M. A. (2025). <em>A reproducible pipeline for processing and geocoding CNPJs from the Brazilian Federal Revenue Service (RFB)</em> [Computer software]. Center for Metropolitan Studies of the University of São Paulo. <a href="https://cem-usp.github.io/rfb-cnpj-geocoding" class="uri">https://cem-usp.github.io/rfb-cnpj-geocoding</a></p>
<p>A BibTeX entry for LaTeX users is</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb46"><pre class="sourceCode latex code-with-copy"><code class="sourceCode latex"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>@software{vartanian2025,</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  title = {A reproducible pipeline for processing and geocoding CNPJs from the Brazilian Federal Revenue Service (RFB)},</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  author = {{Daniel Vartanian} and {Clara de Lima e Silva Penz} and {Gabriel Caldeira} and {Camila Nastari Fernandes} and {Mariana Abrantes Giannotti}},</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  year = {2025},</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  address = {São Paulo},</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  institution = {Center for Metropolitan Studies of the University of São Paulo},</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>  langid = {en},</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>  url = {https://cem-usp.github.io/rfb-cnpj-geocoding}</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section><section id="license" class="level2"><h2 class="anchored" data-anchor-id="license">License</h2>
<div style="text-align: left;">
<p><a href="https://www.gnu.org/licenses/gpl-3.0"><img src="https://img.shields.io/badge/license-GPLv3-bd0000.svg" class="img-fluid" alt="License: GPLv3"></a> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><img src="https://img.shields.io/badge/license-CC_BY--NC--SA_4.0-lightgrey.svg" class="img-fluid" alt="License: CC BY-NC-SA 4.0"></a></p>
</div>
<div class="callout callout-style-simple callout-important">
<div class="callout-body d-flex">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-body-container">
<p>The original data sources may be subject to their own licensing terms and conditions.</p>
</div>
</div>
</div>
<p>The code in this repository is licensed under the <a href="https://www.gnu.org/licenses/gpl-3.0">GNU General Public License Version 3</a>, while the report is available under the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International</a>.</p>
<pre class="text"><code>Copyright (C) 2025 Center for Metropolitan Studies

The code in this report is free software: you can redistribute it and/or
modify it under the terms of the GNU General Public License as published by the
Free Software Foundation, either version 3 of the License, or (at your option)
any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY
WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE. See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with
this program. If not, see &lt;https://www.gnu.org/licenses/&gt;.</code></pre>
</section><section id="acknowledgments" class="level2"><h2 class="anchored" data-anchor-id="acknowledgments">Acknowledgments</h2>
<div style="display: flex; align-items: flex-start; margin-bottom: 2em;">
<div style="flex: 0 0 30%; display: flex; justify-content: center; margin: auto 0;">
<a href="https://doi.org/10.17605/OSF.IO/ZE6WT">
<img src="images/acessosan-logo.svg" alt="AcessoSAN Logo" style="max-width: 140px; width: 100%; height: auto;"></a>
</div>
<div style="flex: 1; padding-left: 1em;">This work is part of a research project by the Polytechnic School (<a href="https://www.poli.usp.br/">Poli</a>) of the University of São Paulo (<a href="https://usp.br/">USP</a>), in partnership with the Secretariat for Food and Nutrition Security (<a href="https://www.gov.br/mds/pt-br/orgaos/SESAN">SESAN</a>) of the Ministry of Social Development, Family, and the Fight Against Hunger (<a href="https://www.gov.br/mds/">MDS</a>), titled: <em>AcessoSAN: Mapping Food Access to Support Public Policies on Food and Nutrition Security and Hunger Reduction in Brazilian Cities</em>.</div>
</div>
<div style="display: flex; align-items: flex-start; margin-bottom: 2em;">
<div style="flex: 0 0 30%; display: flex; justify-content: center; margin: auto 0;">
<a href="https://centrodametropole.fflch.usp.br">
<img src="images/cem-icon.svg" alt="CEM Logo" style="max-width: 190px; width: 100%; height: auto;"></a>
</div>
<div style="flex: 1; padding-left: 1em;">This work was developed with support from the Center for Metropolitan Studies (<a href="https://centrodametropole.fflch.usp.br">CEM</a>) based at the School of Philosophy, Letters and Human Sciences (<a href="https://www.fflch.usp.br/">FFLCH</a>) of the University of São Paulo (<a href="https://usp.br">USP</a>) and at the Brazilian Center for Analysis and Planning (<a href="https://cebrap.org.br/">CEBRAP</a>).</div>
</div>
<div style="display: flex; align-items: flex-start; margin-bottom: 2em;">
<div style="flex: 0 0 30%; display: flex; justify-content: center; margin: auto 0;">
<a href="https://fapesp.br/">
<img src="images/fapesp-logo.svg" alt="FAPESP Logo" style="max-width: 160px; width: 100%; height: auto;"></a>
</div>
<div style="flex: 1; padding-left: 1em;">This study was financed, in part, by the São Paulo Research Foundation (<a href="https://fapesp.br/">FAPESP</a>), Brazil. Process Number <a href="https://bv.fapesp.br/en/bolsas/231507/geospatial-data-science-applied-to-food-policies/">2025/17879-2</a>.</div>
</div>
</section><section id="references" class="level2 unnumbered"><h2 class="unnumbered anchored" data-anchor-id="references">References</h2>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" data-line-spacing="2" role="list">
<div id="ref-allaire" class="csl-entry" role="listitem">
Allaire, J. J., Teague, C., Xie, Y., &amp; Dervieux, C. (n.d.). <em>Quarto</em> [Computer software]. Zenodo. <a href="https://doi.org/10.5281/ZENODO.5960048">https://doi.org/10.5281/ZENODO.5960048</a>
</div>
<div id="ref-hijmans" class="csl-entry" role="listitem">
Hijmans, R. J. (n.d.). <em><span class="nocase">terra</span>: <span>Spatial Data Analysis</span></em> [Computer software]. <a href="https://rspatial.org">https://rspatial.org</a>
</div>
<div id="ref-rcoreteama" class="csl-entry" role="listitem">
R Core Team. (n.d.). <em>R: <span>A</span> language and environment for statistical computing</em> [Computer software]. R Foundation for Statistical Computing. <a href="https://www.R-project.org">https://www.R-project.org</a>
</div>
<div id="ref-usheya" class="csl-entry" role="listitem">
Ushey, K., &amp; Wickham, H. (n.d.). <em><span class="nocase">renv</span>: <span>Project</span> environments</em> [Computer software]. <a href="https://doi.org/10.32614/CRAN.package.renv">https://doi.org/10.32614/CRAN.package.renv</a>
</div>
<div id="ref-wickham2023c" class="csl-entry" role="listitem">
Wickham, H. (2023). <em>The tidy tools manifesto</em>. Tidyverse. <a href="https://tidyverse.tidyverse.org/articles/manifesto.html">https://tidyverse.tidyverse.org/articles/manifesto.html</a>
</div>
<div id="ref-wickham2023e" class="csl-entry" role="listitem">
Wickham, H., Çetinkaya-Rundel, M., &amp; Grolemund, G. (2023). <em>R for data science: <span>Import</span>, tidy, transform, visualize, and model data</em> (2nd ed.). O’Reilly Media. <a href="https://r4ds.hadley.nz">https://r4ds.hadley.nz</a>
</div>
</div>


</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/cem-usp\.github\.io\/rfb-cnpj-geocoding\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/cem-usp/rfb-cnpj-geocoding/edit/main/index.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/cem-usp/rfb-cnpj-geocoding/blob/main/index.qmd" class="toc-action"><i class="bi empty"></i>View source</a></li><li><a href="https://github.com/cem-usp/rfb-cnpj-geocoding/issues/" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer><script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>


</body></html>